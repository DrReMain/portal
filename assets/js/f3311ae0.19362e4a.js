"use strict";(self.webpackChunkgo_zero=self.webpackChunkgo_zero||[]).push([[1689],{3905:function(e,t,n){n.d(t,{Zo:function(){return l},kt:function(){return u}});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var c=r.createContext({}),s=function(e){var t=r.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},l=function(e){var t=s(e.components);return r.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},m=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,c=e.parentName,l=p(e,["components","mdxType","originalType","parentName"]),m=s(n),u=a,h=m["".concat(c,".").concat(u)]||m[u]||d[u]||i;return n?r.createElement(h,o(o({ref:t},l),{},{components:n})):r.createElement(h,o({ref:t},l))}));function u(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=m;var p={};for(var c in t)hasOwnProperty.call(t,c)&&(p[c]=t[c]);p.originalType=e,p.mdxType="string"==typeof e?e:a,o[1]=p;for(var s=2;s<i;s++)o[s]=n[s];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}m.displayName="MDXCreateElement"},5501:function(e,t,n){n.r(t),n.d(t,{default:function(){return d},frontMatter:function(){return p},metadata:function(){return c},toc:function(){return s}});var r=n(7462),a=n(3366),i=(n(7294),n(3905)),o=["components"],p={},c={unversionedId:"deployment/trace",id:"deployment/trace",isDocsHomePage:!1,title:"Trace",description:"Foreword",source:"@site/docs/deployment/trace.md",sourceDirName:"deployment",slug:"/deployment/trace",permalink:"/docs/deployment/trace",editUrl:"https://github.com/zeromicro/portal/edit/main/docs/deployment/trace.md",version:"current",lastUpdatedAt:1676297509,formattedLastUpdatedAt:"2/13/2023",frontMatter:{},sidebar:"docs",previous:{title:"Monitor",permalink:"/docs/deployment/service-monitor"},next:{title:"Trouble Shooting",permalink:"/docs/faq/troubleshooting"}},s=[{value:"Foreword",id:"foreword",children:[]},{value:"Code structure",id:"code-structure",children:[]},{value:"Concept",id:"concept",children:[{value:"SpanContext",id:"spancontext",children:[]},{value:"Span",id:"span",children:[]}]},{value:"Example application",id:"example-application",children:[{value:"HTTP",id:"http",children:[]},{value:"RPC",id:"rpc",children:[]}]},{value:"Summary",id:"summary",children:[]},{value:"Reference",id:"reference",children:[]}],l={toc:s};function d(e){var t=e.components,n=(0,a.Z)(e,o);return(0,i.kt)("wrapper",(0,r.Z)({},l,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"foreword"},"Foreword"),(0,i.kt)("p",null,"In the microservice architecture, the call chain may be very long, from ",(0,i.kt)("inlineCode",{parentName:"p"},"http")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"rpc"),", and from ",(0,i.kt)("inlineCode",{parentName:"p"},"rpc")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"http"),". Developers want to know the call status and performance of each link, the best solution is ",(0,i.kt)("strong",{parentName:"p"},"full link tracking"),"."),(0,i.kt)("p",null,"The tracking method is to generate its own ",(0,i.kt)("inlineCode",{parentName:"p"},"spanID")," at the beginning of a request, and pass it down along the entire request link. We use this ",(0,i.kt)("inlineCode",{parentName:"p"},"spanID")," to view the status of the entire link and performance issues."),(0,i.kt)("p",null,"Let's take a look at the link implementation of ",(0,i.kt)("inlineCode",{parentName:"p"},"go-zero"),"."),(0,i.kt)("h2",{id:"code-structure"},"Code structure"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/zeromicro/go-zero/blob/master/core/trace/spancontext.go"},"spancontext")," \uff1a\u4fdd\u5b58\u94fe\u8def\u7684\u4e0a\u4e0b\u6587\u4fe1\u606f\u300ctraceid\uff0cspanid\uff0c\u6216\u8005\u662f\u5176\u4ed6\u60f3\u8981\u4f20\u9012\u7684\u5185\u5bb9\u300d"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/zeromicro/go-zero/blob/master/core/trace/span.go"},"span")," \uff1a\u94fe\u8def\u4e2d\u7684\u4e00\u4e2a\u64cd\u4f5c\uff0c\u5b58\u50a8\u65f6\u95f4\u548c\u67d0\u4e9b\u4fe1\u606f"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/zeromicro/go-zero/blob/master/core/trace/propagator.go"},"propagator")," \uff1a ",(0,i.kt)("inlineCode",{parentName:"li"},"trace")," \u4f20\u64ad\u4e0b\u6e38\u7684\u64cd\u4f5c\u300c\u62bd\u53d6\uff0c\u6ce8\u5165\u300d"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/zeromicro/go-zero/blob/master/core/trace/noop.go"},"noop")," \uff1a\u5b9e\u73b0\u4e86\u7a7a\u7684 ",(0,i.kt)("inlineCode",{parentName:"li"},"tracer")," \u5b9e\u73b0")),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.gocn.vip/photo/2020/2f244477-4ed3-4ad1-8003-ff82cbe2f8a0.png?x-oss-process=image/resize,w_1920",alt:null})),(0,i.kt)("h2",{id:"concept"},"Concept"),(0,i.kt)("h3",{id:"spancontext"},"SpanContext"),(0,i.kt)("p",null,"Before introducing ",(0,i.kt)("inlineCode",{parentName:"p"},"span"),", first introduce ",(0,i.kt)("inlineCode",{parentName:"p"},"context"),". SpanContext saves the context information of distributed tracing, including Trace id, Span id and other content that needs to be passed downstream. The implementation of OpenTracing needs to pass the SpanContext through a certain protocol to associate the Span in different processes to the same Trace. For HTTP requests, SpanContext is generally passed using HTTP headers."),(0,i.kt)("p",null,"Below is the ",(0,i.kt)("inlineCode",{parentName:"p"},"spanContext")," implemented by ",(0,i.kt)("inlineCode",{parentName:"p"},"go-zero")," by default"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"type spanContext struct {\n    traceId string      // TraceID represents the globally unique ID of tracer\n    spanId  string      // SpanId indicates the unique ID of a span in a single trace, which is unique in the trace\n}\n")),(0,i.kt)("p",null,"At the same time, developers can also implement the interface methods provided by ",(0,i.kt)("inlineCode",{parentName:"p"},"SpanContext")," to realize their own contextual information transfer:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"type SpanContext interface {\n    TraceId() string                        // get TraceId\n    SpanId() string                         // get SpanId\n    Visit(fn func(key, val string) bool)    // Custom operation TraceId, SpanId\n}\n")),(0,i.kt)("h3",{id:"span"},"Span"),(0,i.kt)("p",null,"A REST call or database operation, etc., can be used as a ",(0,i.kt)("inlineCode",{parentName:"p"},"span"),". ",(0,i.kt)("inlineCode",{parentName:"p"},"span")," is the smallest tracking unit of distributed tracing. A trace is composed of multiple spans. The tracking information includes the following information:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"type Span struct {\n    ctx           spanContext       \n    serviceName   string           \n    operationName string           \n    startTime     time.Time         \n    flag          string           \n    children      int              \n}\n")),(0,i.kt)("p",null,"Judging from the definition structure of ",(0,i.kt)("inlineCode",{parentName:"p"},"span"),": In microservices, this is a complete sub-calling process, with the start of the call ",(0,i.kt)("inlineCode",{parentName:"p"},"startTime"),", the context structure ",(0,i.kt)("inlineCode",{parentName:"p"},"spanContext")," that marks its own unique attribute, and the number of child nodes of fork."),(0,i.kt)("h2",{id:"example-application"},"Example application"),(0,i.kt)("p",null,"In ",(0,i.kt)("inlineCode",{parentName:"p"},"go-zero"),", http and rpc have been integrated as built-in middleware. We use ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/zeromicro/go-zero/blob/master/rest/handler/tracinghandler.go"},"http"),", ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/zeromicro/go-zero/blob/master/zrpc/internal/clientinterceptors/tracinginterceptor.go"},"rpc"),", take a look at how ",(0,i.kt)("inlineCode",{parentName:"p"},"tracing")," is used:"),(0,i.kt)("h3",{id:"http"},"HTTP"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},'func TracingHandler(next http.Handler) http.Handler {\n    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {\n        // **1**\n        carrier, err := trace.Extract(trace.HttpFormat, r.Header)\n        // ErrInvalidCarrier means no trace id was set in http header\n        if err != nil && err != trace.ErrInvalidCarrier {\n            logx.Error(err)\n        }\n\n        // **2**\n        ctx, span := trace.StartServerSpan(r.Context(), carrier, sysx.Hostname(), r.RequestURI)\n        defer span.Finish()\n        // **5**\n        r = r.WithContext(ctx)\n\n        next.ServeHTTP(w, r)\n    })\n}\n\nfunc StartServerSpan(ctx context.Context, carrier Carrier, serviceName, operationName string) (\n    context.Context, tracespec.Trace) {\n    span := newServerSpan(carrier, serviceName, operationName)\n    // **4**\n    return context.WithValue(ctx, tracespec.TracingKey, span), span\n}\n\nfunc newServerSpan(carrier Carrier, serviceName, operationName string) tracespec.Trace {\n    // **3**\n    traceId := stringx.TakeWithPriority(func() string {\n        if carrier != nil {\n            return carrier.Get(traceIdKey)\n        }\n        return ""\n    }, func() string {\n        return stringx.RandId()\n    })\n    spanId := stringx.TakeWithPriority(func() string {\n        if carrier != nil {\n            return carrier.Get(spanIdKey)\n        }\n        return ""\n    }, func() string {\n        return initSpanId\n    })\n\n    return &Span{\n        ctx: spanContext{\n            traceId: traceId,\n            spanId:  spanId,\n        },\n        serviceName:   serviceName,\n        operationName: operationName,\n        startTime:     timex.Time(),\n        // \u6807\u8bb0\u4e3aserver\n        flag:          serverFlag,\n    }\n}\n')),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Set header -> carrier to get the traceId and other information in the header"),(0,i.kt)("li",{parentName:"ol"},"Open a new span and encapsulate ",(0,i.kt)("strong",{parentName:"li"},'"traceId, spanId"')," in the context"),(0,i.kt)("li",{parentName:"ol"},'Obtain traceId and spanId from the aforementioned carrier "that is, header"\n-See if it is set in the header\n-If it is not set, it will be randomly generated and returned'),(0,i.kt)("li",{parentName:"ol"},"Generate a new ctx from ",(0,i.kt)("inlineCode",{parentName:"li"},"request"),", encapsulate the corresponding information in ctx, and return"),(0,i.kt)("li",{parentName:"ol"},"From the above context, copy a copy to the current ",(0,i.kt)("inlineCode",{parentName:"li"},"request"))),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://static.gocn.vip/photo/2020/a30daba2-ad12-477c-8ce5-131ef1cc3e76.png?x-oss-process=image/resize,w_1920",alt:null})),(0,i.kt)("p",null,"In this way, the information of the ",(0,i.kt)("inlineCode",{parentName:"p"},"span")," is passed to the downstream service along with the ",(0,i.kt)("inlineCode",{parentName:"p"},"request"),"."),(0,i.kt)("h3",{id:"rpc"},"RPC"),(0,i.kt)("p",null,"There are ",(0,i.kt)("inlineCode",{parentName:"p"},"client, server")," in rpc, so from ",(0,i.kt)("inlineCode",{parentName:"p"},"tracing")," there are also ",(0,i.kt)("inlineCode",{parentName:"p"},"clientTracing, serverTracing"),". The logic of ",(0,i.kt)("inlineCode",{parentName:"p"},"serveTracing")," is basically the same as that of http. Let\u2019s take a look at how ",(0,i.kt)("inlineCode",{parentName:"p"},"clientTracing")," is used?"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-go"},"func TracingInterceptor(ctx context.Context, method string, req, reply interface{},\n    cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error {\n    // open clientSpan\n    ctx, span := trace.StartClientSpan(ctx, cc.Target(), method)\n    defer span.Finish()\n\n    var pairs []string\n    span.Visit(func(key, val string) bool {\n        pairs = append(pairs, key, val)\n        return true\n    })\n    // **3** Add the data in the pair to ctx in the form of a map\n    ctx = metadata.AppendToOutgoingContext(ctx, pairs...)\n\n    return invoker(ctx, method, req, reply, cc, opts...)\n}\n\nfunc StartClientSpan(ctx context.Context, serviceName, operationName string) (context.Context, tracespec.Trace) {\n    // **1**\n    if span, ok := ctx.Value(tracespec.TracingKey).(*Span); ok {\n        // **2**\n        return span.Fork(ctx, serviceName, operationName)\n    }\n\n    return ctx, emptyNoopSpan\n}\n")),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Get the span context information brought down by the upstream"),(0,i.kt)("li",{parentName:"ol"},'Create a new ctx from the acquired span, span "inherit the traceId of the parent span"'),(0,i.kt)("li",{parentName:"ol"},"Add the span generated data to ctx, pass it to the next middleware, and flow downstream")),(0,i.kt)("h2",{id:"summary"},"Summary"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"go-zero")," obtains the link traceID by intercepting the request, and then assigns a root Span at the entry of the middleware function, and then splits the child Spans in subsequent operations. Each span has its own specific identification. After Finsh Will be collected in the link tracking system. Developers can trace the traceID through the ELK tool to see the entire call chain."),(0,i.kt)("p",null,"At the same time, ",(0,i.kt)("inlineCode",{parentName:"p"},"go-zero")," does not provide a complete set of ",(0,i.kt)("inlineCode",{parentName:"p"},"trace")," link solutions. Developers can encapsulate the existing ",(0,i.kt)("inlineCode",{parentName:"p"},"span")," structure of ",(0,i.kt)("inlineCode",{parentName:"p"},"go-zero"),", build their own reporting system, and access links such as ",(0,i.kt)("inlineCode",{parentName:"p"},"jaeger, zipkin"),", etc. Tracking tool."),(0,i.kt)("h2",{id:"reference"},"Reference"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/zeromicro/go-zero/tree/master/core/trace"},"go-zero trace"))))}d.isMDXComponent=!0}}]);