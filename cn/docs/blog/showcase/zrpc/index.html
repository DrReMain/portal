<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="zeromicro">
<meta name="generator" content="Docusaurus v2.0.0-alpha.75">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="icon" href="https://go-zero.dev/favicon.png">
<link rel="icon" href="https://go-zero.dev/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="https://go-zero.dev/img/icons/apple-180x180.png" sizes="180x180">
<meta name="msapplication-config" content="/browserconfig.xml">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="alternate" type="application/rss+xml" href="/cn/blog/rss.xml" title="go-zero Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/cn/blog/atom.xml" title="go-zero Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XZD0YKV3XQ"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XZD0YKV3XQ",{anonymize_ip:!0})</script>
<link rel="manifest" href="//manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c"><title data-react-helmet="true">企业级RPC框架zRPC | go-zero</title><meta data-react-helmet="true" property="og:image" content><meta data-react-helmet="true" name="twitter:image" content><meta data-react-helmet="true" name="twitter:description" content="go-zero 是一个集成了各种工程实践的 web 和 rpc 框架。通过弹性设计保障了大并发服务端的稳定性，经受了充分的实战检验。"><meta data-react-helmet="true" name="twitter:title" content="Introduction | go-zero"><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;Introduction | go-zero&quot;"><meta data-react-helmet="true" property="og:title" content="企业级RPC框架zRPC | go-zero"><meta data-react-helmet="true" name="description" content="近期比较火的开源项目go-zero是一个集成了各种工程实践的包含了Web和RPC协议的功能完善的微服务框架，今天我们就一起来分析一下其中的RPC部分zRPC。"><meta data-react-helmet="true" property="og:description" content="近期比较火的开源项目go-zero是一个集成了各种工程实践的包含了Web和RPC协议的功能完善的微服务框架，今天我们就一起来分析一下其中的RPC部分zRPC。"><link rel="stylesheet" href="/cn/assets/css/styles.284162f0.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="">
<meta itemprop="description" content="go-zero 是一个集成了各种工程实践的 web 和 rpc 框架。通过弹性设计保障了大并发服务端的稳定性，经受了充分的实战检验。">
<meta itemprop="url" content="https://go-zero.dev">
<meta itemprop="logo" content="https://go-zero.dev/img/favicon.png">
<meta itemprop="sameAs" content="https://github.com/zeromicro">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar_wBc8 navbar--light navbar--fixed-top"><div class="navbar__inner inner_Y8Z6"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="brand_AtiA" href="/cn/"><img alt="logo" height="30" src="/cn/img/navbar/logo.svg" class="brand_logo_MqNk"><a class="navbar__brand brand_name_O39n">go-zero</a></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">文档</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/prepare/prepare">环境准备</a></li><li><a class="dropdown__link" href="/cn/docs/quick-start/quick-start">快速开始</a></li><li><a class="dropdown__link" href="/cn/docs/component/components">组件剖析</a></li><li><a class="dropdown__link" href="/cn/docs/advance/advance">进阶指南</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" sidebarid="goctl">goctl</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/goctl/goctl">安装</a></li><li><a class="dropdown__link" href="/cn/docs/goctl/api">API 指令</a></li><li><a class="dropdown__link" href="/cn/docs/goctl/zrpc">RPC 指令</a></li><li><a class="dropdown__link" href="/cn/docs/goctl/model">Model 指令</a></li><li><a class="dropdown__link" href="/cn/docs/goctl/completion">自动补全</a></li><li><a class="dropdown__link" href="/cn/docs/goctl/tutorial/tutorial">视频教程</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">生态</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/eco/plugins">Goctl 插件</a></li><li><a class="dropdown__link" href="/cn/docs/eco/editor">编辑器插件</a></li><li><a class="dropdown__link" href="/cn/docs/eco/distributed-transaction">分布式事务 (DTM)</a></li><li><a class="dropdown__link" href="/cn/docs/eco/showcase">案例展示</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">社区</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/community/about-us">关于我们</a></li><li><a class="dropdown__link" href="/cn/docs/community/contribute">参与贡献</a></li><li><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="dropdown__link">GitHub</a></li><li><a href="https://discord.gg/4JQvC5A4Fe" target="_blank" rel="noopener noreferrer" class="dropdown__link">Discord</a></li></ul></div><a class="navbar__item navbar__link" sidebarid="blog" href="/cn/docs/blog/blog">博客</a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link">更多</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/cn/docs/resource-center/learning-resource">资源中心</a></li><li><a href="https://space.bilibili.com/389552232/channel/seriesdetail?sid=2122723" target="_blank" rel="noopener noreferrer" class="dropdown__link">视频教程</a></li><li><a href="https://github.com/zeromicro/go-zero/blob/master/ROADMAP.md" target="_blank" rel="noopener noreferrer" class="dropdown__link">开发路线图</a></li><li><a class="dropdown__link" href="/cn/docs/design/design">设计文档</a></li><li><a class="dropdown__link" href="/cn/docs/faq/troubleshooting">FAQ</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="searchWrapper_glLF"><div class="navbar__search searchBarContainer_I7kZ"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_Zg7X searchBarLoadingRing_J5Ez"><div></div><div></div><div></div><div></div></div><div class="searchHintContainer_CDc6"><kbd class="searchHint_2RRg">ctrl</kbd><kbd class="searchHint_2RRg">K</kbd></div></div></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__item navbar__link"><span><svg t="1651714104711" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8547" width="24" height="24" style="vertical-align:text-bottom;margin-right:5px"><path d="M0 0h1024v1024H0z" fill="#FFFFFF" p-id="8548"></path><path d="M785.09056 297.86112l-0.01024-176.40448-253.61408 87.18336 253.62432 89.22112zM499.3024 197.64224L232.58112 102.4v184.1664l266.72128-88.92416zM334.1824 337.37728l44.46208-12.70784v53.97504l95.26272-34.9184v171.4688l-38.11328 12.6976v-25.38496l-63.50848 25.38496 0.27648 95.41632-38.37952 12.55424-0.28672-94.44352-63.21152 24.576 0.01024 19.05664-38.12352 12.6976 0.01024-171.45856 101.60128-31.75424v-57.15968z m101.61152 60.33408l-57.14944 22.2208v63.50848l57.14944-19.05664v-66.67264zM270.68416 521.54368l63.50848-22.23104-0.01024-66.67264-63.49824 22.2208v66.68288z m247.67488-308.40832l-342.9376 117.88288v469.9648l342.9376-114.3296V213.13536z m9.55392 489.41056c-123.38176 41.30816-248.24832 82.5344-371.54816 123.83232l-0.01024-508.0576L804.1472 102.4v202.16832l63.50848 20.10112-0.01024 489.0112-339.73248-111.13472z m266.6496-20.1728c-14.92992-53.98528-29.9008-108.19584-44.9024-162.54976-15.0528-54.49728-30.11584-109.24032-45.2608-164.15744-16.22016-6.28736-32.48128-12.60544-48.81408-18.944-14.85824 43.61216-29.76768 87.36768-44.6976 131.21536l-45.056 132.28032c16.57856 5.96992 33.16736 11.9296 49.68448 17.85856 6.4-20.1728 12.8-40.36608 19.18976-60.54912 30.49472 11.1616 60.9792 22.3232 91.46368 33.47456 6.5024 24.65792 12.99456 49.28512 19.51744 73.8304 16.32256 5.86752 32.63488 11.70432 48.87552 17.54112zM711.30112 535.8592c-10.5472-40.2944-21.10464-80.59904-31.58016-120.90368-10.31168 32.5632-20.60288 65.14688-30.90432 97.73056 20.8384 7.71072 41.65632 15.45216 62.48448 23.17312z m-30.53568 312.10496c-121.21088 75.776-241.60256 85.18656-365.38368 6.51264l-6.62528 10.35264c118.45632 75.264 236.3392 74.07616 357.65248 6.01088 7.10656-4.03456 14.08-8.192 20.992-12.51328L701.44 880.25088l31.87712-58.5728-66.53952 4.42368 13.98784 21.8624z" p-id="8549"></path></svg><span>中文简体</span></span></a><ul class="dropdown__menu"><li><a href="/docs/blog/showcase/zrpc" target="_self" rel="noopener noreferrer" class="dropdown__link" style="text-transform:capitalize">English</a></li><li><a href="/cn/docs/blog/showcase/zrpc" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">中文简体</a></li></ul></div><a href="https://github.com/zeromicro/go-zero" class="navbar__items navbar__items--right"><img alt="forks" height="30" src="/cn/img/navbar/github-dark.svg" class="star__fork_dBtt"><div class="star_fork_layout_ROo5"><img alt="stars" height="20" src="https://img.shields.io/github/stars/zeromicro/go-zero?style=social" class="star__fork_dBtt"><img alt="forks" height="20" src="https://img.shields.io/github/forks/zeromicro/go-zero?style=social" class="star__fork_dBtt"></div></a><div class="react-toggle themeToggleInHeading_b3Mq react-toggle--checked react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_1y7K" style="margin-left:2px"><svg t="1651718448922" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2080" width="200" height="200"><path d="M439.04383639 224.33271976a289.43717504 289.43717504 0 0 0-89.06329676 39.44690807c-27.5075319 18.12412161-51.158867 39.64960558-70.96389486 64.57645191-19.79019562 24.92684633-35.31880082 53.25011237-46.62042137 84.97474006C221.10449032 445.05050411 215.45368042 478.01109252 215.45368042 512c0 40.16870887 7.81621301 78.48347702 23.45358166 115.04318192 15.64725682 36.67341315 36.77228986 68.19039996 63.2910532 94.76354538 26.53359488 26.56820206 58.11485196 47.57952611 94.69927585 63.23667111 36.59431134 15.65714501 75.00301286 23.48324474 115.16183354 23.48324475 33.97407594 0 66.85061917-5.56182137 98.62468557-16.89310498 31.76417894-11.32633953 60.10227581-26.77584294 85.01429133-46.65502781 24.87740834-19.77536407 46.43255539-43.46625042 64.57150781-70.96389488a290.15403174 290.15403174 0 0 0 39.43701989-88.98913905c-8.3056532 0.72180079-17.71378249 1.13213991-28.0958481 1.1321392-45.21637032 0-88.35138342-8.85936294-129.45942212-26.46932463-41.1327577-17.71872658-76.62459295-41.50848964-106.44089858-71.27535655C505.84007277 458.54719011 482.10963587 423.01086095 464.42057238 381.91765379 446.7562286 340.81455917 437.94135957 297.65977044 437.94135957 252.4483442c0-10.40184195 0.39550758-19.77536407 1.15685891-28.01674772l-0.049438-0.09887672zM512.02976157 141.21192041c8.32542811 0 16.51242896 0.31146168 24.6054972 0.92944167-16.4036648 35.32374419-24.60549719 72.09603405-24.60549719 110.30698212 0 35.12104668 6.84227598 68.69961578 20.58121076 100.83458258 13.70927096 32.03114601 32.15474243 59.63261126 55.35124448 82.80933769 23.16683898 23.17178306 50.76830423 41.60736635 82.82416923 55.30674985 32.02125855 13.69938351 65.654209 20.60098567 100.78514387 20.60098568 38.23072298 0 75.03267594-8.24138293 110.35147675-24.62032874 0.59326099 8.14250622 0.86517214 16.28006837 0.86517213 24.62032874 0 33.57856837-4.43956893 66.43533597-13.29893256 98.46648269-8.90880166 32.03114601-21.28817928 61.69419283-37.24195443 88.78149743-15.92411206 27.19112615-35.31880082 52.11797247-58.09013296 74.87941716-22.77627549 22.76144395-47.74267309 42.12152555-74.87447306 58.09013223-27.15157487 15.96366261-56.75529553 28.32326532-88.78644152 37.28644905A368.16784419 368.16784419 0 0 1 512.00009921 882.78807959a368.20739474 368.20739474 0 0 1-98.48625832-13.28904439c-32.03609009-8.95824037-61.6249792-21.31784236-88.79138561-37.28150569-27.12685589-15.96860669-52.08336529-35.32868827-74.89919206-58.09013223-22.7515565-22.76144395-42.13635709-47.68829101-58.05058169-74.87941715-15.96366261-27.0922487-28.34304097-56.75529553-37.2518426-88.78149744A367.9354836 367.9354836 0 0 1 141.21201889 512c0-33.57856837 4.4494571-66.43533597 13.30882004-98.46648269 8.90880166-32.03114601 21.28817928-61.69419283 37.25184259-88.78149744 15.91916798-27.19112615 35.29902519-52.11797247 58.0505817-74.87941715 22.81582676-22.86526476 47.77233617-42.22534634 74.89919206-58.09013223C351.89380578 175.81880789 381.4826949 163.36032846 413.51878498 154.50096479A368.20739474 368.20739474 0 0 1 512.00009921 141.21192041h0.02966236z" p-id="2081" fill="#ffffff"></path></svg></span></div><div class="react-toggle-track-x"><span class="toggle_1y7K" style="margin-left:1px"><svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1940" width="25" height="25"><path d="M752.41931153 240.7063601c8.36993432 0 15.62255883 3.08990502 21.72821045 9.16589356 6.1353147 6.08093262 9.18566918 13.3928833 9.18566918 21.73315382 0 8.55285621-3.05035376 15.85986352-9.18566918 21.94079614l-43.67394996 43.66900658c-5.93261719 5.97216773-13.17041016 8.95825195-21.72326709 8.95825195-8.87420678 0-16.20098901-2.98608422-22.08911085-8.75061035-5.88317847-5.87329102-8.80004906-13.2890625-8.80004906-22.14843774 0-8.54791283 2.95642114-15.75604272 8.91375732-21.72821044l43.66900659-43.67394996c6.14025879-6.07598853 13.44726539-9.16589356 21.98034668-9.16589356z m37.66223167 240.39459181h61.79809547c8.52813721 0 15.82031227 2.98608422 21.83697534 9.06207276C879.78271508 496.24395728 882.78857422 503.45208717 882.78857422 512c0 8.55285621-3.00585914 15.85986352-9.07196021 21.83697533-6.01666236 6.07598853-13.30883813 9.06207276-21.83697534 9.06207276h-61.79809547c-8.52813721 0-15.80053734-2.98608422-21.86663841-9.06207276-6.01666236-5.97711182-9.05712867-13.2890625-9.05712867-21.83697533 0-8.55285621 3.04046631-15.76098609 9.05712867-21.83697533 6.06610107-6.07598853 13.33850122-9.06207276 21.86663841-9.06207276zM512 141.21142578c8.52813721 0 15.79064917 3.08990502 21.85180688 9.06207276 6.02160645 6.08093262 9.05712867 13.3928833 9.05712867 21.83697533v61.79809546c0 8.55285621-3.03552222 15.85986352-9.0521853 21.83697534-6.06610107 6.07598853-13.32861305 9.16589356-21.85675025 9.16589355-8.53802467 0-15.80053734-3.08990502-21.86663842-9.16589355-6.01666236-5.97711182-9.0521853-13.2890625-9.05218458-21.83697534V172.11047387c0-8.44409203 3.03552222-15.76098609 9.05218458-21.83697533C496.20440674 144.3013308 503.46691871 141.21142578 512.00494408 141.21142578zM271.81304907 240.7063601c8.36499023 0 15.61267066 3.08990502 21.743042 9.16589356l43.66900659 43.67394996c6.14025879 6.07598853 9.17083764 13.38793922 9.17083764 21.72821044 0 8.55285621-3.01080323 15.86480689-9.05712938 21.83697534-6.03149391 6.08093262-13.30389404 9.06207276-21.85180617 9.06207275-8.69622827 0-16.02795386-2.98608422-21.95068359-8.85443115l-43.68383814-43.67395068c-5.97216773-5.97216773-8.92858886-13.28411842-8.92858886-22.03967284 0-8.55285621 3.00585914-15.76098609 9.07196021-21.83697462 6.01666236-5.97216773 13.30883813-9.06207276 21.85675096-9.06207276h-0.03955126z m436.93725586 436.91253615c8.36499023 0 15.60772729 2.98608422 21.72326709 9.16589355l43.67394995 43.67395067c6.1353147 6.17980933 9.18566918 13.38793922 9.18566919 21.93585205 0 8.34521461-3.05035376 15.65716529-9.18566919 21.73315382-6.1105957 6.17980933-13.35827613 9.16589356-21.72326636 9.16589356-8.52813721 0-15.84008789-2.98608422-21.98034668-9.16589356l-43.66900659-43.66900587c-5.95733618-5.87329102-8.91375732-13.1852417-8.91375732-21.73315453 0-8.55285621 3.01080323-15.86480689 9.05712866-21.94079614 6.03149391-6.07598853 13.32861305-9.16589356 21.85180689-9.16589355h-0.01977564zM512.00494408 388.40380836c-34.12243628 0-63.22192359 12.05310035-87.39239525 36.2532351-24.1358645 24.10125732-36.21368384 53.25018335-36.21368384 87.34295654 0 34.0927732 12.07782007 63.24169922 36.21368384 87.44677734C448.78796387 623.53814721 477.88250709 635.59619164 512 635.59619164c34.12243628 0 63.23181176-12.05310035 87.4072268-36.15435838C623.51837158 575.2466433 635.59619164 546.09771729 635.59619164 512c0-34.0927732-12.07782007-63.24169922-36.18896484-87.34295654C575.23181176 400.45690942 546.12243628 388.40380836 512 388.40380836zM172.12036133 481.10095191h61.79809547c8.53802467 0 15.80053734 2.98608422 21.86663841 9.06207276 6.01666236 6.08093262 9.05712867 13.2890625 9.05712867 21.83697533 0 8.55285621-3.04046631 15.85986352-9.05712867 21.83697533-6.06610107 6.07598853-13.32861305 9.06207276-21.86663841 9.06207276h-61.79809547c-8.52813721 0-15.81042481-2.98608422-21.83697534-9.06207276C144.21728492 527.85986352 141.21142578 520.54791283 141.21142578 512c0-8.55285621 3.00585914-15.76098609 9.07196021-21.83697533 6.03149391-6.07598853 13.30883813-9.06207276 21.83697534-9.06207276zM512.00494408 759.19238258c8.52813721 0 15.79064917 2.98608422 21.85180617 9.06207274 6.02160645 6.08093262 9.05712867 13.2890625 9.05712938 21.83697535v61.79809546c0 8.55285621-3.03552222 15.85986352-9.0521853 21.83697533C527.79559326 879.80249 520.53308129 882.78857422 512 882.78857422c-8.53802467 0-15.80053734-2.98608422-21.86663842-9.06207276-6.01666236-5.97711182-9.0521853-13.2890625-9.05218458-21.83697533v-61.79809546c0-8.55285621 3.03552222-15.76098609 9.05218458-21.83697534 6.06610107-6.07598853 13.32861305-9.06207276 21.86663842-9.06207275z m-196.47839379-81.57348633c8.5034182 0 15.80053734 2.98608422 21.84686279 9.16589355 6.03149391 6.08093262 9.07196021 13.3928833 9.07196021 21.94079614 0 8.44409203-3.08001685 15.65222192-9.19555664 21.72821044l-43.67394995 43.67394996c-6.10565162 6.17980933-13.34838867 9.16589356-21.72326637 9.16589356-8.54791283 0-15.84008789-2.98608422-21.85180687-8.96319533-6.07104516-6.07598853-9.0769043-13.38793922-9.0769043-21.93585205 0-8.65173364 2.95642114-15.96862769 8.92858887-21.94079614l43.68383813-43.66900658c6.10565162-6.17980933 13.44232202-9.16589356 21.95068359-9.16589355h0.03955054zM512 326.60571289c33.628052 0 64.6506958 8.34521461 93.0481565 24.81811547 28.42712378 16.69042992 50.92163109 39.1404419 67.4637456 67.56756568 16.57177758 28.32824708 24.86755347 59.32617188 24.86755347 93.00860596 0 33.68243408-8.27600098 64.68035888-24.86755347 93.10748267-16.58166504 28.32824708-39.08605981 50.77825904-67.4637456 67.4637456-28.36285424 16.58166504-59.37561059 24.82305884-93.0481565 24.82305884-33.66760254 0-64.67047143-8.24139381-93.05804468-24.81811547-28.37768578-16.69042992-50.86230492-39.14538598-67.46374487-67.46868897-16.58166504-28.42712378-24.86755347-59.42504859-24.86755348-93.10748267 0-33.68243408 8.31555152-64.68035888 24.86755348-93.00860596 16.55200195-28.42712378 39.03662109-50.87713647 67.46374487-67.56262231C447.35424828 334.94598413 478.371948 326.60571289 512 326.60571289z" p-id="1941"></path></svg></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_AtiA" href="/cn/">go-zero</a><div class="react-toggle themeToggleInSidebar_qGRI react-toggle--checked react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_1y7K" style="margin-left:2px"><svg t="1651718448922" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2080" width="200" height="200"><path d="M439.04383639 224.33271976a289.43717504 289.43717504 0 0 0-89.06329676 39.44690807c-27.5075319 18.12412161-51.158867 39.64960558-70.96389486 64.57645191-19.79019562 24.92684633-35.31880082 53.25011237-46.62042137 84.97474006C221.10449032 445.05050411 215.45368042 478.01109252 215.45368042 512c0 40.16870887 7.81621301 78.48347702 23.45358166 115.04318192 15.64725682 36.67341315 36.77228986 68.19039996 63.2910532 94.76354538 26.53359488 26.56820206 58.11485196 47.57952611 94.69927585 63.23667111 36.59431134 15.65714501 75.00301286 23.48324474 115.16183354 23.48324475 33.97407594 0 66.85061917-5.56182137 98.62468557-16.89310498 31.76417894-11.32633953 60.10227581-26.77584294 85.01429133-46.65502781 24.87740834-19.77536407 46.43255539-43.46625042 64.57150781-70.96389488a290.15403174 290.15403174 0 0 0 39.43701989-88.98913905c-8.3056532 0.72180079-17.71378249 1.13213991-28.0958481 1.1321392-45.21637032 0-88.35138342-8.85936294-129.45942212-26.46932463-41.1327577-17.71872658-76.62459295-41.50848964-106.44089858-71.27535655C505.84007277 458.54719011 482.10963587 423.01086095 464.42057238 381.91765379 446.7562286 340.81455917 437.94135957 297.65977044 437.94135957 252.4483442c0-10.40184195 0.39550758-19.77536407 1.15685891-28.01674772l-0.049438-0.09887672zM512.02976157 141.21192041c8.32542811 0 16.51242896 0.31146168 24.6054972 0.92944167-16.4036648 35.32374419-24.60549719 72.09603405-24.60549719 110.30698212 0 35.12104668 6.84227598 68.69961578 20.58121076 100.83458258 13.70927096 32.03114601 32.15474243 59.63261126 55.35124448 82.80933769 23.16683898 23.17178306 50.76830423 41.60736635 82.82416923 55.30674985 32.02125855 13.69938351 65.654209 20.60098567 100.78514387 20.60098568 38.23072298 0 75.03267594-8.24138293 110.35147675-24.62032874 0.59326099 8.14250622 0.86517214 16.28006837 0.86517213 24.62032874 0 33.57856837-4.43956893 66.43533597-13.29893256 98.46648269-8.90880166 32.03114601-21.28817928 61.69419283-37.24195443 88.78149743-15.92411206 27.19112615-35.31880082 52.11797247-58.09013296 74.87941716-22.77627549 22.76144395-47.74267309 42.12152555-74.87447306 58.09013223-27.15157487 15.96366261-56.75529553 28.32326532-88.78644152 37.28644905A368.16784419 368.16784419 0 0 1 512.00009921 882.78807959a368.20739474 368.20739474 0 0 1-98.48625832-13.28904439c-32.03609009-8.95824037-61.6249792-21.31784236-88.79138561-37.28150569-27.12685589-15.96860669-52.08336529-35.32868827-74.89919206-58.09013223-22.7515565-22.76144395-42.13635709-47.68829101-58.05058169-74.87941715-15.96366261-27.0922487-28.34304097-56.75529553-37.2518426-88.78149744A367.9354836 367.9354836 0 0 1 141.21201889 512c0-33.57856837 4.4494571-66.43533597 13.30882004-98.46648269 8.90880166-32.03114601 21.28817928-61.69419283 37.25184259-88.78149744 15.91916798-27.19112615 35.29902519-52.11797247 58.0505817-74.87941715 22.81582676-22.86526476 47.77233617-42.22534634 74.89919206-58.09013223C351.89380578 175.81880789 381.4826949 163.36032846 413.51878498 154.50096479A368.20739474 368.20739474 0 0 1 512.00009921 141.21192041h0.02966236z" p-id="2081" fill="#ffffff"></path></svg></span></div><div class="react-toggle-track-x"><span class="toggle_1y7K" style="margin-left:1px"><svg class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1940" width="25" height="25"><path d="M752.41931153 240.7063601c8.36993432 0 15.62255883 3.08990502 21.72821045 9.16589356 6.1353147 6.08093262 9.18566918 13.3928833 9.18566918 21.73315382 0 8.55285621-3.05035376 15.85986352-9.18566918 21.94079614l-43.67394996 43.66900658c-5.93261719 5.97216773-13.17041016 8.95825195-21.72326709 8.95825195-8.87420678 0-16.20098901-2.98608422-22.08911085-8.75061035-5.88317847-5.87329102-8.80004906-13.2890625-8.80004906-22.14843774 0-8.54791283 2.95642114-15.75604272 8.91375732-21.72821044l43.66900659-43.67394996c6.14025879-6.07598853 13.44726539-9.16589356 21.98034668-9.16589356z m37.66223167 240.39459181h61.79809547c8.52813721 0 15.82031227 2.98608422 21.83697534 9.06207276C879.78271508 496.24395728 882.78857422 503.45208717 882.78857422 512c0 8.55285621-3.00585914 15.85986352-9.07196021 21.83697533-6.01666236 6.07598853-13.30883813 9.06207276-21.83697534 9.06207276h-61.79809547c-8.52813721 0-15.80053734-2.98608422-21.86663841-9.06207276-6.01666236-5.97711182-9.05712867-13.2890625-9.05712867-21.83697533 0-8.55285621 3.04046631-15.76098609 9.05712867-21.83697533 6.06610107-6.07598853 13.33850122-9.06207276 21.86663841-9.06207276zM512 141.21142578c8.52813721 0 15.79064917 3.08990502 21.85180688 9.06207276 6.02160645 6.08093262 9.05712867 13.3928833 9.05712867 21.83697533v61.79809546c0 8.55285621-3.03552222 15.85986352-9.0521853 21.83697534-6.06610107 6.07598853-13.32861305 9.16589356-21.85675025 9.16589355-8.53802467 0-15.80053734-3.08990502-21.86663842-9.16589355-6.01666236-5.97711182-9.0521853-13.2890625-9.05218458-21.83697534V172.11047387c0-8.44409203 3.03552222-15.76098609 9.05218458-21.83697533C496.20440674 144.3013308 503.46691871 141.21142578 512.00494408 141.21142578zM271.81304907 240.7063601c8.36499023 0 15.61267066 3.08990502 21.743042 9.16589356l43.66900659 43.67394996c6.14025879 6.07598853 9.17083764 13.38793922 9.17083764 21.72821044 0 8.55285621-3.01080323 15.86480689-9.05712938 21.83697534-6.03149391 6.08093262-13.30389404 9.06207276-21.85180617 9.06207275-8.69622827 0-16.02795386-2.98608422-21.95068359-8.85443115l-43.68383814-43.67395068c-5.97216773-5.97216773-8.92858886-13.28411842-8.92858886-22.03967284 0-8.55285621 3.00585914-15.76098609 9.07196021-21.83697462 6.01666236-5.97216773 13.30883813-9.06207276 21.85675096-9.06207276h-0.03955126z m436.93725586 436.91253615c8.36499023 0 15.60772729 2.98608422 21.72326709 9.16589355l43.67394995 43.67395067c6.1353147 6.17980933 9.18566918 13.38793922 9.18566919 21.93585205 0 8.34521461-3.05035376 15.65716529-9.18566919 21.73315382-6.1105957 6.17980933-13.35827613 9.16589356-21.72326636 9.16589356-8.52813721 0-15.84008789-2.98608422-21.98034668-9.16589356l-43.66900659-43.66900587c-5.95733618-5.87329102-8.91375732-13.1852417-8.91375732-21.73315453 0-8.55285621 3.01080323-15.86480689 9.05712866-21.94079614 6.03149391-6.07598853 13.32861305-9.16589356 21.85180689-9.16589355h-0.01977564zM512.00494408 388.40380836c-34.12243628 0-63.22192359 12.05310035-87.39239525 36.2532351-24.1358645 24.10125732-36.21368384 53.25018335-36.21368384 87.34295654 0 34.0927732 12.07782007 63.24169922 36.21368384 87.44677734C448.78796387 623.53814721 477.88250709 635.59619164 512 635.59619164c34.12243628 0 63.23181176-12.05310035 87.4072268-36.15435838C623.51837158 575.2466433 635.59619164 546.09771729 635.59619164 512c0-34.0927732-12.07782007-63.24169922-36.18896484-87.34295654C575.23181176 400.45690942 546.12243628 388.40380836 512 388.40380836zM172.12036133 481.10095191h61.79809547c8.53802467 0 15.80053734 2.98608422 21.86663841 9.06207276 6.01666236 6.08093262 9.05712867 13.2890625 9.05712867 21.83697533 0 8.55285621-3.04046631 15.85986352-9.05712867 21.83697533-6.06610107 6.07598853-13.32861305 9.06207276-21.86663841 9.06207276h-61.79809547c-8.52813721 0-15.81042481-2.98608422-21.83697534-9.06207276C144.21728492 527.85986352 141.21142578 520.54791283 141.21142578 512c0-8.55285621 3.00585914-15.76098609 9.07196021-21.83697533 6.03149391-6.07598853 13.30883813-9.06207276 21.83697534-9.06207276zM512.00494408 759.19238258c8.52813721 0 15.79064917 2.98608422 21.85180617 9.06207274 6.02160645 6.08093262 9.05712867 13.2890625 9.05712938 21.83697535v61.79809546c0 8.55285621-3.03552222 15.85986352-9.0521853 21.83697533C527.79559326 879.80249 520.53308129 882.78857422 512 882.78857422c-8.53802467 0-15.80053734-2.98608422-21.86663842-9.06207276-6.01666236-5.97711182-9.0521853-13.2890625-9.05218458-21.83697533v-61.79809546c0-8.55285621 3.03552222-15.76098609 9.05218458-21.83697534 6.06610107-6.07598853 13.32861305-9.06207276 21.86663842-9.06207275z m-196.47839379-81.57348633c8.5034182 0 15.80053734 2.98608422 21.84686279 9.16589355 6.03149391 6.08093262 9.07196021 13.3928833 9.07196021 21.94079614 0 8.44409203-3.08001685 15.65222192-9.19555664 21.72821044l-43.67394995 43.67394996c-6.10565162 6.17980933-13.34838867 9.16589356-21.72326637 9.16589356-8.54791283 0-15.84008789-2.98608422-21.85180687-8.96319533-6.07104516-6.07598853-9.0769043-13.38793922-9.0769043-21.93585205 0-8.65173364 2.95642114-15.96862769 8.92858887-21.94079614l43.68383813-43.66900658c6.10565162-6.17980933 13.44232202-9.16589356 21.95068359-9.16589355h0.03955054zM512 326.60571289c33.628052 0 64.6506958 8.34521461 93.0481565 24.81811547 28.42712378 16.69042992 50.92163109 39.1404419 67.4637456 67.56756568 16.57177758 28.32824708 24.86755347 59.32617188 24.86755347 93.00860596 0 33.68243408-8.27600098 64.68035888-24.86755347 93.10748267-16.58166504 28.32824708-39.08605981 50.77825904-67.4637456 67.4637456-28.36285424 16.58166504-59.37561059 24.82305884-93.0481565 24.82305884-33.66760254 0-64.67047143-8.24139381-93.05804468-24.81811547-28.37768578-16.69042992-50.86230492-39.14538598-67.46374487-67.46868897-16.58166504-28.42712378-24.86755347-59.42504859-24.86755348-93.10748267 0-33.68243408 8.31555152-64.68035888 24.86755348-93.00860596 16.55200195-28.42712378 39.03662109-50.87713647 67.46374487-67.56262231C447.35424828 334.94598413 478.371948 326.60571289 512 326.60571289z" p-id="1941"></path></svg></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" checked="" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a href="#" role="button" class="menu__link menu__link--sublist"><span><svg t="1651714104711" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="8547" width="24" height="24" style="vertical-align:text-bottom;margin-right:5px"><path d="M0 0h1024v1024H0z" fill="#FFFFFF" p-id="8548"></path><path d="M785.09056 297.86112l-0.01024-176.40448-253.61408 87.18336 253.62432 89.22112zM499.3024 197.64224L232.58112 102.4v184.1664l266.72128-88.92416zM334.1824 337.37728l44.46208-12.70784v53.97504l95.26272-34.9184v171.4688l-38.11328 12.6976v-25.38496l-63.50848 25.38496 0.27648 95.41632-38.37952 12.55424-0.28672-94.44352-63.21152 24.576 0.01024 19.05664-38.12352 12.6976 0.01024-171.45856 101.60128-31.75424v-57.15968z m101.61152 60.33408l-57.14944 22.2208v63.50848l57.14944-19.05664v-66.67264zM270.68416 521.54368l63.50848-22.23104-0.01024-66.67264-63.49824 22.2208v66.68288z m247.67488-308.40832l-342.9376 117.88288v469.9648l342.9376-114.3296V213.13536z m9.55392 489.41056c-123.38176 41.30816-248.24832 82.5344-371.54816 123.83232l-0.01024-508.0576L804.1472 102.4v202.16832l63.50848 20.10112-0.01024 489.0112-339.73248-111.13472z m266.6496-20.1728c-14.92992-53.98528-29.9008-108.19584-44.9024-162.54976-15.0528-54.49728-30.11584-109.24032-45.2608-164.15744-16.22016-6.28736-32.48128-12.60544-48.81408-18.944-14.85824 43.61216-29.76768 87.36768-44.6976 131.21536l-45.056 132.28032c16.57856 5.96992 33.16736 11.9296 49.68448 17.85856 6.4-20.1728 12.8-40.36608 19.18976-60.54912 30.49472 11.1616 60.9792 22.3232 91.46368 33.47456 6.5024 24.65792 12.99456 49.28512 19.51744 73.8304 16.32256 5.86752 32.63488 11.70432 48.87552 17.54112zM711.30112 535.8592c-10.5472-40.2944-21.10464-80.59904-31.58016-120.90368-10.31168 32.5632-20.60288 65.14688-30.90432 97.73056 20.8384 7.71072 41.65632 15.45216 62.48448 23.17312z m-30.53568 312.10496c-121.21088 75.776-241.60256 85.18656-365.38368 6.51264l-6.62528 10.35264c118.45632 75.264 236.3392 74.07616 357.65248 6.01088 7.10656-4.03456 14.08-8.192 20.992-12.51328L701.44 880.25088l31.87712-58.5728-66.53952 4.42368 13.98784 21.8624z" p-id="8549"></path></svg><span>Languages</span></span></a><ul class="menu__list"><li class="menu__list-item"><a href="/docs/blog/showcase/zrpc" target="_self" rel="noopener noreferrer" class="menu__link" style="text-transform:capitalize">English</a></li><li class="menu__list-item"><a href="/cn/docs/blog/showcase/zrpc" target="_self" rel="noopener noreferrer" class="menu__link dropdown__link--active" style="text-transform:capitalize">中文简体</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">文档</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/cn/docs/prepare/prepare">环境准备</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/quick-start/quick-start">快速开始</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/component/components">组件剖析</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/advance/advance">进阶指南</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist" sidebarid="goctl">goctl</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/cn/docs/goctl/goctl">安装</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/goctl/api">API 指令</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/goctl/zrpc">RPC 指令</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/goctl/model">Model 指令</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/goctl/completion">自动补全</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/goctl/tutorial/tutorial">视频教程</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">生态</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/cn/docs/eco/plugins">Goctl 插件</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/eco/editor">编辑器插件</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/eco/distributed-transaction">分布式事务 (DTM)</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/eco/showcase">案例展示</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">社区</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/cn/docs/community/about-us">关于我们</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/community/contribute">参与贡献</a></li><li class="menu__list-item"><a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://discord.gg/4JQvC5A4Fe" target="_blank" rel="noopener noreferrer" class="menu__link">Discord</a></li></ul></li><li class="menu__list-item"><a class="menu__link" sidebarid="blog" href="/cn/docs/blog/blog">博客</a></li><li class="menu__list-item menu__list-item--collapsed"><a role="button" class="menu__link menu__link--sublist">更多</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/cn/docs/resource-center/learning-resource">资源中心</a></li><li class="menu__list-item"><a href="https://space.bilibili.com/389552232/channel/seriesdetail?sid=2122723" target="_blank" rel="noopener noreferrer" class="menu__link">视频教程</a></li><li class="menu__list-item"><a href="https://github.com/zeromicro/go-zero/blob/master/ROADMAP.md" target="_blank" rel="noopener noreferrer" class="menu__link">开发路线图</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/design/design">设计文档</a></li><li class="menu__list-item"><a class="menu__link" href="/cn/docs/faq/troubleshooting">FAQ</a></li></ul></li></ul></div></div></div></nav><div class="wrapper_DIJ0"><div class="doc_D+rh"><div class="doc__sidebar_gVFN" role="complementary"><div class="sidebar_LIo8"><div class="menu menu--responsive thin-scrollbar menu_oAhv"><button aria-label="打开" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_nrF-" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" href="/cn/docs/blog/blog">博客</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">服务治理</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/governance/bloom">bloom</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/governance/breaker-algorithms">熔断原理与实现</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/governance/loadshedding">服务自适应降载保护设计</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/governance/periodlimit">periodlimit</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/governance/tokenlimit">tokenlimit</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">缓存设计</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/cache/cache">DB缓存机制</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/cache/redis-cache">go-zero缓存设计之持久层缓存</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/cache/business-cache">go-zero缓存设计之业务层缓存</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/cache/collection">通过 collection.Cache 进行缓存</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">组件介绍</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/tool/executors">executors</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/tool/keywords">高效的关键词替换和敏感词过滤工具</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/tool/logx">logx</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">并发编程</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/concurrency/fx">fx</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/concurrency/mapreduce">通过MapReduce降低服务响应时间</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/concurrency/stream">流数据处理利器</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/concurrency/redis-lock">redis lock</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/concurrency/sharedcalls">防止缓存击穿之进程内共享调用</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">原理介绍</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/principle/timing-wheel">TimingWheel</a></li></ul></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u menu__link--sublist menu__link--active" href="#!">案例展示</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/cn/docs/blog/showcase/shorturl">快速构建高并发微服务</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menuLink_Zq3u menu__link--active active" tabindex="0" href="/cn/docs/blog/showcase/zrpc">企业级RPC框架zRPC</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/cn/docs/blog/showcase/mysql">mysql</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/cn/docs/blog/showcase/mapping">文本序列化和反序列化</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/cn/docs/blog/showcase/datacenter">我是如何用 go-zero 实现一个中台系统</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/cn/docs/blog/showcase/go-queue">go-zero 分布式定时任务</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/cn/docs/blog/showcase/go-zero-looklook">使用go-zero开发一个旅游系统go-zero-looklook</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="0" href="/cn/docs/blog/showcase/metric">基于prometheus的微服务指标监控</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menuLink_Zq3u menu__link--sublist" href="#!">线上交流</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/share/online-exchange">10月3日线上交流问题汇总</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/share/goctl-share-part-one">goctl 效能工具深度解析（一）</a></li><li class="menu__list-item"><a class="menu__link menuLink_Zq3u" tabindex="-1" href="/cn/docs/blog/share/goctl-share-part-two">goctl 效能工具深度解析（二）</a></li></ul></li></ul></div></div></div><main class="doc__main_VklL"><div class="padding-vert--lg container doc__item-wrapper_FIxd"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><header><h1 class="docTitle_-X99">企业级RPC框架zRPC</h1></header><div class="markdown"><p>近期比较火的开源项目<a href="https://github.com/zeromicro/go-zero" target="_blank" rel="noopener noreferrer">go-zero</a>是一个集成了各种工程实践的包含了Web和RPC协议的功能完善的微服务框架，今天我们就一起来分析一下其中的RPC部分<a href="https://github.com/zeromicro/go-zero/tree/master/zrpc" target="_blank" rel="noopener noreferrer">zRPC</a>。</p><p>zRPC底层依赖gRPC，内置了服务注册、负载均衡、拦截器等模块，其中还包括自适应降载，自适应熔断，限流等微服务治理方案，是一个简单易用的可直接用于生产的企业级RPC框架。</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="zrpc初探"></a>zRPC初探<a class="hash-link" href="#zrpc初探" title="跳转到标题">#</a></h3><p>zRPC支持直连和基于etcd服务发现两种方式，我们以基于etcd做服务发现为例演示zRPC的基本使用：</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="配置"></a>配置<a class="hash-link" href="#配置" title="跳转到标题">#</a></h5><p>创建hello.yaml配置文件，配置如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI yml"><div tabindex="0" class="prism-code language-yml codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token key atrule">Name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> hello.rpc           // 服务名</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">ListenOn</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> 127.0.0.1</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">9090  // 服务监听地址</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token key atrule">Etcd</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">Hosts</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">-</span><span class="token plain"> 127.0.0.1</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">2379      // etcd服务地址</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token key atrule">Key</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> hello.rpc          // 服务注册key</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="创建proto文件"></a>创建proto文件<a class="hash-link" href="#创建proto文件" title="跳转到标题">#</a></h5><p>创建hello.proto文件，并生成对应的go代码</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI protobuf"><div tabindex="0" class="prism-code language-protobuf codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">syntax = &quot;proto3&quot;;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">package pb;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">service Greeter {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  rpc SayHello (HelloRequest) returns (HelloReply) {}</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">}</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">message HelloRequest {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  string name = 1;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">}</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">message HelloReply {</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  string message = 1;</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>生成go代码</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">$ protoc --go_out</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">plugins</span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain">grpc:. hello.proto</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="server端"></a>Server端<a class="hash-link" href="#server端" title="跳转到标题">#</a></h5><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">package</span><span class="token plain"> main</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;context&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;flag&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;log&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;example/zrpc/pb&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;github.com/zeromicro/go-zero/core/conf&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;github.com/zeromicro/go-zero/zrpc&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;google.golang.org/grpc&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> Config </span><span class="token keyword" style="color:#ff79c6">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    zrpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">RpcServerConf</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> cfgFile </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">String</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;f&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;./hello.yaml&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;cfg file&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">main</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    flag</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Parse</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> cfg Config</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    conf</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">MustLoad</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">cfgFile</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">cfg</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    srv</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> zrpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">NewServer</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cfg</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">RpcServerConf</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">s </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Server</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        pb</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">RegisterGreeterServer</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">Hello</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        log</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Fatal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    srv</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Start</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> Hello </span><span class="token keyword" style="color:#ff79c6">struct</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">h </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">Hello</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">SayHello</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> in </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">pb</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">HelloRequest</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">pb</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">HelloReply</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">pb</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">HelloReply</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">Message</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;hello &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">+</span><span class="token plain"> in</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="client端"></a>Client端<a class="hash-link" href="#client端" title="跳转到标题">#</a></h5><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">package</span><span class="token plain"> main</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">import</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;context&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;log&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;example/zrpc/pb&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;github.com/zeromicro/go-zero/core/discov&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token string" style="color:#f1fa8c">&quot;github.com/zeromicro/go-zero/zrpc&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">main</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    client </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> zrpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">MustNewClient</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">zrpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">RpcClientConf</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        Etcd</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> discov</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">EtcdConf</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            Hosts</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token string" style="color:#f1fa8c">&quot;127.0.0.1:2379&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            Key</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain">   </span><span class="token string" style="color:#f1fa8c">&quot;hello.rpc&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    conn </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Conn</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    hello </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">NewGreeterClient</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    reply</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> hello</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">SayHello</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Background</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">pb</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">HelloRequest</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">Name</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;go-zero&quot;</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        log</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Fatal</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    log</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Println</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">reply</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>启动服务，查看服务是否注册：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI shell"><div tabindex="0" class="prism-code language-shell codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">$ </span><span class="token assign-left variable" style="color:#ff79c6">ETCDCTL_API</span><span class="token operator" style="color:#ff79c6">=</span><span class="token number" style="color:#50fa7b">3</span><span class="token plain"> etcdctl get hello.rpc --prefix</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>显示服务已经注册：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go-zero"><div tabindex="0" class="prism-code language-go-zero codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">hello.rpc/7587849401504590084</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">127.0.0.1:9090</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>运行客户端即可看到输出：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go-zero"><div tabindex="0" class="prism-code language-go-zero codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token plain">hello go-zero</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>这个例子演示了zRPC的基本使用，可以看到通过zRPC构建RPC服务非常简单，只需要很少的几行代码，接下来我们继续进行探索</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="zrpc原理分析"></a>zRPC原理分析<a class="hash-link" href="#zrpc原理分析" title="跳转到标题">#</a></h3><p>下图展示zRPC的架构图和主要组成部分</p><p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/zrpc.png" alt="zrpc"></p><p>zRPC主要有以下几个模块组成：</p><ul><li>discov: 服务发现模块，基于etcd实现服务发现功能</li><li>resolver: 服务注册模块，实现了gRPC的resolver.Builder接口并注册到gRPC</li><li>interceptor: 拦截器，对请求和响应进行拦截处理</li><li>balancer: 负载均衡模块，实现了p2c负载均衡算法，并注册到gRPC </li><li>client: zRPC客户端，负责发起请求</li><li>server: zRPC服务端，负责处理请求 </li></ul><p>这里介绍了zRPC的主要组成模块和每个模块的主要功能，其中resolver和balancer模块实现了gRPC开放的接口，实现了自定义的resolver和balancer，拦截器模块是整个zRPC的功能重点，自适应降载、自适应熔断、prometheus服务指标收集等功能都在这里实现</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="interceptor模块"></a>Interceptor模块<a class="hash-link" href="#interceptor模块" title="跳转到标题">#</a></h3><p>gRPC提供了拦截器功能，主要是对请求前后进行额外处理的拦截操作，其中拦截器包含客户端拦截器和服务端拦截器，又分为一元(Unary)拦截器和流(Stream)拦截器，这里我们主要讲解一元拦截器，流拦截器同理。</p><p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/interceptor.png" alt="interceptor"></p><p>客户端拦截器定义如下:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> UnaryClientInterceptor </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> method </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> reply </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> cc </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> invoker UnaryInvoker</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#ff79c6">...</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>其中method为方法名，req，reply分别为请求和响应参数，cc为客户端连接对象，invoker参数是真正执行rpc方法的handler其实在拦截器中被调用执行</p><p>服务端拦截器定义如下:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> UnaryServerInterceptor </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> req </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> info </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">UnaryServerInfo</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> handler UnaryHandler</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">resp </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>其中req为请求参数，info中包含了请求方法属性，handler为对server端方法的包装，也是在拦截器中被调用执行</p><p>zRPC中内置了丰富的拦截器，其中包括自适应降载、自适应熔断、权限验证、prometheus指标收集等等，由于拦截器较多，篇幅有限没法所有的拦截器给大家一一解析，这里我们主要分析两个，自适应熔断和prometheus服务监控指标收集：</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="内置拦截器分析"></a>内置拦截器分析<a class="hash-link" href="#内置拦截器分析" title="跳转到标题">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="自适应熔断breaker"></a>自适应熔断(breaker)<a class="hash-link" href="#自适应熔断breaker" title="跳转到标题">#</a></h5><p>当客户端向服务端发起请求，客户端会记录服务端返回的错误，当错误达到一定的比例，客户端会自行的进行熔断处理，丢弃掉一定比例的请求以保护下游依赖，且可以自动恢复。zRPC中自适应熔断遵循<a href="https://landing.google.com/sre/sre-book/chapters/handling-overload" target="_blank" rel="noopener noreferrer">《Google SRE》</a>中过载保护策略，算法如下：</p><p>requests: 总请求数量</p><p>accepts: 正常请求数量 </p><p>K: 倍值 (Google SRE推荐值为2)</p><p>可以通过修改K的值来修改熔断发生的激进程度，降低K的值会使得自适应熔断算法更加激进，增加K的值则自适应熔断算法变得不再那么激进</p><p><a href="https://github.com/zeromicro/go-zero/blob/master/zrpc/internal/clientinterceptors/breakerinterceptor.go" target="_blank" rel="noopener noreferrer">熔断拦截器</a>定义如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">BreakerInterceptor</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> method </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> reply </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    cc </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> invoker grpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UnaryInvoker</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#ff79c6">...</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// target + 方法名</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    breakerName </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> path</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Join</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Target</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> breaker</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">DoWithAcceptable</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">breakerName</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 真正执行调用</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">invoker</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> reply</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#ff79c6">...</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> codes</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Acceptable</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>accept方法实现了Google SRE过载保护算法，判断否进行熔断</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">b </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">googleBreaker</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">accept</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">     </span><span class="token comment" style="color:#6272a4">// accepts为正常请求数，total为总请求数</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   accepts</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> total </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">history</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   weightedAccepts </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">k </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">float64</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">accepts</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token comment" style="color:#6272a4">// 算法实现</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   dropRatio </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> math</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Max</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#8be9fd">float64</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">total</span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">protection</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">weightedAccepts</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#ff79c6">/</span><span class="token function" style="color:#8be9fd">float64</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">total</span><span class="token operator" style="color:#ff79c6">+</span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> dropRatio </span><span class="token operator" style="color:#ff79c6">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">     </span><span class="token comment" style="color:#6272a4">// 是否超过比例</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> b</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">proba</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">TrueOnProba</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">dropRatio</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> ErrServiceUnavailable</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>doReq方法首先判断是否熔断，满足条件直接返回error(circuit breaker is open)，不满足条件则对请求数进行累加</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">b </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">googleBreaker</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">doReq</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">req </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> fallback </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> acceptable Acceptable</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">accept</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> fallback </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">         </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">fallback</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">         </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token keyword" style="color:#ff79c6">defer</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> e </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">recover</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> e </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">         b</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">markFailure</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">         </span><span class="token function" style="color:#8be9fd">panic</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token comment" style="color:#6272a4">// 此处执行RPC请求</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">req</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token comment" style="color:#6272a4">// 正常请求total和accepts都会加1</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">acceptable</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      b</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">markSuccess</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">     </span><span class="token comment" style="color:#6272a4">// 请求失败只有total会加1</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      b</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">markFailure</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">   </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="prometheus指标收集"></a>prometheus指标收集<a class="hash-link" href="#prometheus指标收集" title="跳转到标题">#</a></h5><p>服务监控是了解服务当前运行状态以及变化趋势的重要手段，监控依赖于服务指标的收集，通过prometheus进行监控指标的收集是业界主流方案，zRPC中也采用了prometheus来进行指标的收集</p><p><a href="https://github.com/zeromicro/go-zero/blob/master/zrpc/internal/serverinterceptors/prometheusinterceptor.go" target="_blank" rel="noopener noreferrer">prometheus拦截器</a>定义如下：</p><p>这个拦截器主要是对服务的监控指标进行收集，这里主要是对RPC方法的耗时和调用错误进行收集，这里主要使用了Prometheus的Histogram和Counter数据类型</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">UnaryPrometheusInterceptor</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UnaryServerInterceptor </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> req </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> info </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UnaryServerInfo</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> handler grpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UnaryHandler</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 执行前记录一个时间</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        startTime </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> timex</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Now</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        resp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">handler</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 执行后通过Since算出执行该调用的耗时</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        metricServerReqDur</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Observe</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#8be9fd">int64</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">timex</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Since</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">startTime</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token operator" style="color:#ff79c6">/</span><span class="token plain">time</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Millisecond</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> info</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">FullMethod</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 方法对应的错误码</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        metricServerReqCodeTotal</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Inc</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">info</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">FullMethod</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> strconv</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Itoa</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#8be9fd">int</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Code</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="添加自定义拦截器"></a>添加自定义拦截器<a class="hash-link" href="#添加自定义拦截器" title="跳转到标题">#</a></h4><p>除了内置了丰富的拦截器之外，zRPC同时支持添加自定义拦截器</p><p>Client端通过AddInterceptor方法添加一元拦截器：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">rc </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">RpcClient</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">AddInterceptor</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">interceptor grpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UnaryClientInterceptor</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    rc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">client</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">AddInterceptor</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">interceptor</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>Server端通过AddUnaryInterceptors方法添加一元拦截器：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">rs </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">RpcServer</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">AddUnaryInterceptors</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">interceptors </span><span class="token operator" style="color:#ff79c6">...</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">UnaryServerInterceptor</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    rs</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">server</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">AddUnaryInterceptors</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">interceptors</span><span class="token operator" style="color:#ff79c6">...</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="resolver模块"></a>resolver模块<a class="hash-link" href="#resolver模块" title="跳转到标题">#</a></h3><p>zRPC服务注册架构图：</p><p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/resolver.png" alt="resolver"></p><p>zRPC中自定义了resolver模块，用来实现服务的注册功能。zRPC底层依赖gRPC，在gRPC中要想自定义resolver需要实现resolver.Builder接口：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> Builder </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#8be9fd">Build</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">target Target</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> cc ClientConn</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> opts BuildOptions</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Resolver</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#8be9fd">Scheme</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>其中Build方法返回Resolver，Resolver定义如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">type</span><span class="token plain"> Resolver </span><span class="token keyword" style="color:#ff79c6">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#8be9fd">ResolveNow</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ResolveNowOptions</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#8be9fd">Close</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>在zRPC中定义了两种resolver，direct和discov，这里我们主要分析基于etcd做服务发现的discov，自定义的resolver需要通过gRPC提供了Register方法进行注册代码如下：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">RegisterResolver</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    resolver</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Register</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">dirBuilder</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    resolver</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Register</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">disBuilder</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>当我们启动我们的zRPC Server的时候，调用Start方法，会像etcd中注册对应的服务地址：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ags keepAliveServer</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">Start</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">fn RegisterFn</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// 注册服务地址</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> ags</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">registerEtcd</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 启动服务</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> ags</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Server</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Start</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">fn</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>当我们启动zRPC客户端的时候，在gRPC内部会调用我们自定义resolver的Build方法，zRPC通过在Build方法内调用执行了resolver.ClientConn的UpdateState方法，该方法会把服务地址注册到gRPC客户端内部：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">d </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">discovBuilder</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">Build</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">target resolver</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Target</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> cc resolver</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> opts resolver</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">BuildOptions</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    resolver</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Resolver</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    hosts </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> strings</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">FieldsFunc</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Authority</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">r </span><span class="token builtin" style="color:#bd93f9">rune</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> r </span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain"> EndpointSepChar</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// 服务发现</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    sub</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> discov</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">NewSubscriber</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">hosts</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Endpoint</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    update </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> addrs </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain">resolver</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Address</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">_</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> val </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">range</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">subset</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">sub</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Values</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> subsetSize</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            addrs </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">append</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">addrs</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> resolver</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Address</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                Addr</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> val</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 向gRPC注册服务地址</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        cc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">UpdateState</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">resolver</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">State</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            Addresses</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> addrs</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// 监听</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    sub</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">AddListener</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">update</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token function" style="color:#8be9fd">update</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 返回自定义的resolver.Resolver</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">nopResolver</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">cc</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>在discov中，通过调用load方法从etcd中获取指定服务的所有地址：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">load</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cli EtcdClient</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> key </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> resp </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">clientv3</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">GetResponse</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> err </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        ctx</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> cancel </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">WithTimeout</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">context</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cli</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> RequestTimeout</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token comment" style="color:#6272a4">// 从etcd中获取指定服务的所有地址</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        resp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> cli</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Get</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">makeKeyPrefix</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clientv3</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">WithPrefix</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token function" style="color:#8be9fd">cancel</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">break</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        logx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Error</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        time</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Sleep</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">coolDownInterval</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> kvs </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain">KV</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Lock</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">_</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> ev </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">range</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Kvs </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        kvs </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">append</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">kvs</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> KV</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            Key</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">string</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ev</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Key</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            Val</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">string</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ev</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Unlock</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">handleChanges</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> kvs</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>并通过watch监听服务地址的变化：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">cluster</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">watch</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cli EtcdClient</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> key </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    rch </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> cli</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Watch</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">clientv3</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">WithRequireLeader</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">context</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">cli</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">makeKeyPrefix</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> clientv3</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">WithPrefix</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">case</span><span class="token plain"> wresp</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&lt;-</span><span class="token plain">rch</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">!</span><span class="token plain">ok </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                logx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Error</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;etcd monitor chan has been closed&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> wresp</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Canceled </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                logx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Error</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;etcd monitor chan has been canceled&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> wresp</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Err</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                logx</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Error</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Sprintf</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;etcd monitor chan error: %v&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> wresp</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Err</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token comment" style="color:#6272a4">// 监听变化通知更新</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">handleWatchEvents</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> wresp</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Events</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">case</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&lt;-</span><span class="token plain">c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">done</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>这部分主要介绍了zRPC中是如何自定义的resolver，以及基于etcd的服务发现原理，通过这部分的介绍大家可以了解到zRPC内部服务注册发现的原理，源代码比较多只是粗略的从整个流程上进行了分析，如果大家对zRPC的源码比较感兴趣可以自行进行学习</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="balancer模块"></a>balancer模块<a class="hash-link" href="#balancer模块" title="跳转到标题">#</a></h3><p>负载均衡原理图：</p><p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/balancer.png"></p><p>避免过载是负载均衡策略的一个重要指标，好的负载均衡算法能很好的平衡服务端资源。常用的负载均衡算法有轮训、随机、Hash、加权轮训等。但为了应对各种复杂的场景，简单的负载均衡算法往往表现的不够好，比如轮训算法当服务响应时间变长就很容易导致负载不再平衡， 因此zRPC中自定义了默认负载均衡算法P2C(Power of Two Choices)，和resolver类似，要想自定义balancer也需要实现gRPC定义的balancer.Builder接口，由于和resolver类似这里不再带大家一起分析如何自定义balancer，感兴趣的朋友可以查看gRPC相关的文档来进行学习</p><p>注意，zRPC是在客户端进行负载均衡，常见的还有通过nginx中间代理的方式</p><p>zRPC框架中默认的负载均衡算法为P2C，该算法的主要思想是：</p><ol><li>从可用节点列表中做两次随机选择操作，得到节点A、B</li><li>比较A、B两个节点，选出负载最低的节点作为被选中的节点</li></ol><p>伪代码如下：</p><p><img src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/random_pseudo.png"></p><p>主要算法逻辑在Pick方法中实现：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">p </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">p2cPicker</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">Pick</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> info balancer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">PickInfo</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    conn balancer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">SubConn</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> done </span><span class="token keyword" style="color:#ff79c6">func</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">balancer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">DoneInfo</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Lock</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">defer</span><span class="token plain"> p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Unlock</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> chosen </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">subConn</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">switch</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">len</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">case</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> balancer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">ErrNoSubConnAvailable</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">case</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        chosen </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">choose</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">case</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">2</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        chosen </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">choose</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">default</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> node1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> node2 </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">subConn</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">for</span><span class="token plain"> i </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">0</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> i </span><span class="token operator" style="color:#ff79c6">&lt;</span><span class="token plain"> pickTimes</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> i</span><span class="token operator" style="color:#ff79c6">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// 随机数</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            a </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">r</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Intn</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#8be9fd">len</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            b </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">r</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Intn</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#8be9fd">len</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> b </span><span class="token operator" style="color:#ff79c6">&gt;=</span><span class="token plain"> a </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                b</span><span class="token operator" style="color:#ff79c6">++</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// 随机获取所有节点中的两个节点</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            node1 </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">a</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            node2 </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">conns</span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">b</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span><span class="token comment" style="color:#6272a4">// 效验节点是否健康</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> node1</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">healthy</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;&amp;</span><span class="token plain"> node2</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">healthy</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">                </span><span class="token keyword" style="color:#ff79c6">break</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4">// 选择其中一个节点</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        chosen </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">choose</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">node1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> node2</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    atomic</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">AddInt64</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">chosen</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">inflight</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    atomic</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">AddInt64</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">chosen</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">requests</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token number" style="color:#50fa7b">1</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> chosen</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">conn</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">buildDoneFunc</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">chosen</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>choose方法对随机选择出来的节点进行负载比较从而最终确定选择哪个节点</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">p </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">p2cPicker</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">choose</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">c1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> c2 </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">subConn</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">subConn </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    start </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">int64</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">timex</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Now</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> c2 </span><span class="token operator" style="color:#ff79c6">==</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        atomic</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">StoreInt64</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">c1</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">pick</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> start</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> c1</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> c1</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">load</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token plain"> c2</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">load</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        c1</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> c2 </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> c2</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> c1</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    pick </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">LoadInt64</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">c2</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">pick</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> start</span><span class="token operator" style="color:#ff79c6">-</span><span class="token plain">pick </span><span class="token operator" style="color:#ff79c6">&gt;</span><span class="token plain"> forcePick </span><span class="token operator" style="color:#ff79c6">&amp;&amp;</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">CompareAndSwapInt64</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">c2</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">pick</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> pick</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> start</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> c2</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        atomic</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">StoreInt64</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">c1</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">pick</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> start</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> c1</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>上面主要介绍了zRPC默认负载均衡算法的设计思想和代码实现，那自定义的balancer是如何注册到gRPC的呢，resolver提供了Register方法来进行注册，同样balancer也提供了Register方法来进行注册：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">init</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    balancer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">Register</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token function" style="color:#8be9fd">newBuilder</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">newBuilder</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> balancer</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Builder </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> base</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">NewBalancerBuilder</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">Name</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">new</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">p2cPickerBuilder</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>注册balancer之后gRPC怎么知道使用哪个balancer呢？这里我们需要使用配置项进行配置，在NewClient的时候通过grpc.WithBalancerName方法进行配置：</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><div tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar"><div class="codeBlockLines_1zSZ" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">func</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">NewClient</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">target </span><span class="token builtin" style="color:#bd93f9">string</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#ff79c6">...</span><span class="token plain">ClientOption</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token operator" style="color:#ff79c6">*</span><span class="token plain">client</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token builtin" style="color:#bd93f9">error</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">var</span><span class="token plain"> cli client</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    opts </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">append</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">opts</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">WithDialOption</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">WithBalancerName</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">p2c</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">if</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">:=</span><span class="token plain"> cli</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token function" style="color:#8be9fd">dial</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">target</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#ff79c6">...</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"> err </span><span class="token operator" style="color:#ff79c6">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> err</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token keyword" style="color:#ff79c6">return</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">&amp;</span><span class="token plain">cli</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token boolean" style="color:#bd93f9">nil</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div><button type="button" aria-label="代码复制" class="copyButton_M3SB">复制</button></div></div><p>这部分主要介绍了zRPC中内中的负载均衡算法的实现原理以及具体的实现方式，之后介绍了zRPC是如何注册自定义的balancer以及如何选择自定义的balancer，通过这部分大家应该对负载均衡有了更进一步的认识</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_WiXH" id="总结"></a>总结<a class="hash-link" href="#总结" title="跳转到标题">#</a></h3><p>首先，介绍了zRPC的基本使用方法，可以看到zRPC使用非常简单，只需要少数几行代码就可以构建高性能和自带服务治理能力的RPC服务，当然这里没有面面俱到的介绍zRPC的基本使用，大家可以查看相关文档进行学习</p><p>接着，介绍了zRPC的几个重要组成模块以及其实现原理，并分析了部分源码。拦截器模块是整个zRPC的重点，其中内置了丰富的功能，像熔断、监控、降载等等也是构建高可用微服务必不可少的。resolver和balancer模块自定义了gRPC的resolver和balancer，通过该部分可以了解到整个服务注册与发现的原理以及如何构建自己的服务发现系统，同时自定义负载均衡算法也变得不再神秘</p><p>最后，zRPC是一个经历过各种工程实践的RPC框架，不论是想要用于生产还是学习其中的设计模式都是一个不可多得的开源项目。希望通过这篇文章的介绍大家能够进一步了解zRPC</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/zeromicro/portal/edit/main/i18n/cn/docusaurus-plugin-content-docs/current/blog/showcase/zrpc.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col text--right"><em><small>最后更新 日期： <time datetime="2023-02-24T04:03:13.000Z" class="lastUpdatedDate_nN9m">2/24/2023</time></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="文档页面导航"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cn/docs/blog/showcase/shorturl"><div class="pagination-nav__sublabel">上一篇</div><div class="pagination-nav__label">« 快速构建高并发微服务</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cn/docs/blog/showcase/mysql"><div class="pagination-nav__sublabel">下一篇</div><div class="pagination-nav__label">mysql »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#zrpc初探" class="table-of-contents__link">zRPC初探</a></li><li><a href="#zrpc原理分析" class="table-of-contents__link">zRPC原理分析</a></li><li><a href="#interceptor模块" class="table-of-contents__link">Interceptor模块</a></li><li><a href="#resolver模块" class="table-of-contents__link">resolver模块</a></li><li><a href="#balancer模块" class="table-of-contents__link">balancer模块</a></li><li><a href="#总结" class="table-of-contents__link">总结</a></li></ul></div></div></div></div></main></div></div><footer class="footer_rm3y section_bQ6r"><div class="footer__inner_OWoZ section--inner_6-fB"><div class="footer__column_+a5z footer__column--left_4bpB"><div><img alt="go-zero logo" class="footer__logo_ayM4" height="27" src="/cn/img/footer/go-zero.svg" title="go-zero" width="108"><img alt="stars" height="27" src="https://img.shields.io/github/stars/zeromicro/go-zero?style=social" class="footer__logo_ayM4"><img alt="forks" height="27" src="https://img.shields.io/github/forks/zeromicro/go-zero?style=social" class="footer__logo_ayM4"></div><p class="footer__tagline_b1u+">go-zero 是一个集成了各种工程实践的 web 和 rpc 框架</p><a class="footer__github_okz3 button_f7Ff button--icon_q89D button--secondary_x3vq button--xsmall_fwzy" href="https://github.com/zeromicro/go-zero" rel="noopener noreferrer" target="_blank"><img alt="GitHub logo" height="22" src="/cn/img/github.svg" title="GitHub" width="22">Star us on GitHub</a></div><div class="footer__column_+a5z footer__column--right_FGdI"><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">zeromicro</li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/zero-api" rel="noopener noreferrer" target="_blank">zero-api</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/go-queue" rel="noopener noreferrer" target="_blank">go-queue</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/awesome-zero" rel="noopener noreferrer" target="_blank">awesome-zero</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/zero-examples" rel="noopener noreferrer" target="_blank">zero-example</a></li></ul></div><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">社区</li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/go-zero" rel="noopener noreferrer" target="_blank">GitHub</a></li><li class="footer__item_K578"><span></span></li></ul></div><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">友情链接</li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://legacy.go-zero.dev" rel="noopener noreferrer" target="_blank">旧文档</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="/cn/docs/blog/blog">博客</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/go-zero/blob/master/ROADMAP.md" rel="noopener noreferrer" target="_blank">开发路线图</a></li><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://landscape.cncf.io/?selected=go-zero" rel="noopener noreferrer" target="_blank">CNCF</a></li></ul></div><div class="footer__links_5pu0"><ul class="footer__items_3d9P"><li class="footer__title_ulcL">微信二维码</li><li class="footer__item_K578"><div data-rmiz-wrap="visible"><img alt="微信群" width="80" src="https://raw.githubusercontent.com/zeromicro/zero-doc/main/doc/images/wechat.jpg" class="footer__img_4fbU"><button aria-label="Zoom image" data-rmiz-btn-open="true"></button></div></li></ul></div></div></div><div class="footer__bottom_rXtt"><p class="footer__copyright_9e29">Copyright © 2023 zeromicro</p><ul><li class="footer__item_K578"><a class="footer__link_l-+N" href="https://github.com/zeromicro/portal/blob/main/LICENSE">License</a></li></ul><p></p></div></footer></div>
<script src="/cn/assets/js/main.e139c336.js" defer="defer"></script>
</body>
</html>